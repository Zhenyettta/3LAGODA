{% extends 'base.html' %}

{% block title %}
    Product List
{% endblock %}


{% block head %}
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/view_list.css' %}">
{% endblock %}

{% block content %}

    <a class="button" onclick="location.href='/manager/'"><</a>

    <div class="checkout-container">
        <table class="product-table">
            <thead>
            <tr>
                <th>UPC</th>
                <th>Product ID</th>
                <th>Name</th>
                <th>Price</th>
                <th>Count</th>
                <th>Prom</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for product in products %}
                <tr>
                    <td>{{ product.0 }}</td>
                    <td>{{ product.1 }}</td>
                    <td>{{ product.2 }}</td>
                    <td>{{ product.3 }}</td>
                    <td>{{ product.4 }}</td>
                    <td>{{ product.5 }}</td>
                    <td>
                        <input type="number" name="quantity" min="1" value="1">
                        <button class="add-to-cart-button" data-product-id="{{ product.1 }}">Додати</button>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        <form method="post" action="{% url 'create_check' %}">
            {% csrf_token %}
            <table class="cart-table">
                <thead>
                <tr>
                    <th>UPC</th>
                    <th>Product ID</th>
                    <th>Name</th>
                    <th>Selling price</th>
                    <th>Count</th>
                    <th>Prom</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody class="cart-items"></tbody>
            </table>
            <button id="send-data" class="sale-button" type="submit">Відправити дані</button>
        </form>
    </div>

    <script>
        const addToCartButtons = document.querySelectorAll('.add-to-cart-button');
        const cartItemsContainer = document.querySelector('.cart-items');

        addToCartButtons.forEach((button) => {
            button.addEventListener('click', () => {
                const productRow = button.closest('tr');
                const productData = [...productRow.children].map((td) => td.textContent);
                const countInput = productRow.querySelector('input[name="quantity"]');
                let price = productData[3];
                const count = parseInt(countInput.value);
                const productId = button.dataset.productId;
                const promotionalCheckbox = productData[5] === 'True';
                const existingCartItem = Array.from(cartItemsContainer.children).find((row) =>
                    row.querySelector('td:nth-child(2)').textContent === productId
                );

                if (promotionalCheckbox) {
                    price *= 0.8;
                }

                if (existingCartItem) {
                    const existingCountCell = existingCartItem.querySelector('td:nth-child(5)');
                    const existingCount = parseInt(existingCountCell.textContent);
                    existingCountCell.textContent = existingCount + count;
                } else {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                <td>${productData[0]}</td>
                <td>${productData[1]}</td>
                <td>${productData[2]}</td>
                <td>${price}</td>
                <td>${count}</td>
                <td>${productData[5]}</td>
                <td><button class="delete-button">Delete</button></td>
            `;
                    cartItemsContainer.appendChild(newRow);
                }
            });
        });

        cartItemsContainer.addEventListener('click', (event) => {
            if (event.target.classList.contains('delete-button')) {
                const cartItemRow = event.target.closest('tr');
                const countCell = cartItemRow.querySelector('td:nth-child(5)');
                let count = parseInt(countCell.textContent);

                if (count > 1) {
                    count--;
                    countCell.textContent = count;
                } else {
                    cartItemRow.remove();
                }
            }
        });
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        $('#send-data').click(function() {
            var data = [];

            $('.cart-items tr').each(function() {
                var row = [];
                $(this).find('td').each(function() {
                    row.push($(this).text());
                });
                data.push(row);
            });

            $.ajax({
                type: 'POST',
                url: '{% url "create_check" %}',
                data: {
                    'data': JSON.stringify(data),
                    'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {

                    console.log(response);
                },
                error: function(xhr, errmsg, err) {

                    console.log(xhr.status + ': ' + xhr.responseText);
                }
            });
        });
    });
</script>
{% endblock %}K